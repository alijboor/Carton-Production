<!DOCTYPE html>
<html>

<head>
    <link rel='stylesheet' href='../../cssFile/addorder.css'>

    <title>اضافة طلبية</title>
    <meta charset="UTF-8">
    <link href="https://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

</head>
<script>
    $(function () {
        $("#sidebar").load("../dashboard/sidebar.html");
    });
</script>

<body>
    <div id="sidebar"></div>

    <div class="main-block">
        <h1>اضافة طلبية</h1>
        <form id="save">
            <div class="save">
                <div class="info">
                    <input class="fname" type="text" name="name" id="name" placeholder="اسم الزبون / الشركة">
                    <!-- <input type="text" name="email " id="email" placeholder="ايميل الزبون / الشركة">
                    <input type="text" name="phone" id="phone" placeholder="رقم الهاتف"> -->
                    <div class="item status">
                        <p>نوع الصنف:</p>
                        <div class="status-item">
                        </div>
                    </div>
                </div>
                <p>
                    السعر النهائي
                    <input type="text" name="totalPrice" id="totalPrice" disabled>
                </p>
                <!-- <a class="btn btn-primary" onclick="Calc()">احسب السعر النهائي</a> -->

                <div class="note">
                    <p>ملاحظات: </p>
                    <textarea rows="5" id="note"></textarea>
                </div>

                <p>ارفق ملف التصميم المرغوب طلبه:</p>
                <input type="file" name="file" accept="file/*" id="file">
                <!-- <a class="btn btn-primary" onclick="UploadFile()">ارفع الملف</a> -->
                <br><br><a class="btn btn-primary" onclick="AddOrder()">ارسل الطلب الاّن</a>
            </div>
        </form>
    </div>
</body>

<script>
    var userid;
    $.get("../../phpFiles/getsessiondata.php", { webToken: document.cookie }, function (sessiondata, stauts) {
        var session = JSON.parse(sessiondata);
        console.log(session);
        userid = session.userid;
        if (session.error == 1) {
            window.location.replace("../index.html");
        }
        if (session.role != -1) {
            window.location.replace("orders.html");
        }
    });
    var items = [];
    $.get("../../phpFiles/orders/getitem.php", { webToken: document.cookie }, function (data, stauts) {

        data = JSON.parse(data);
        items = data;
        var datTable = '';

        for (let j = 0; j < data.length; j++) {
            datTable += "<tr><td>" + data[j][0] + "</td>";
            datTable += "<td><input type='text' id='price" + j + "' value=" + data[j][1] + " disabled></td></td>"
            datTable += "<td><input type='text' id='quantity" + j + "' onchange='Calc()' placeholder='الكمية' name ='items' ></td></tr>";
        }
        // <td><input type='text' id='price" + j + "' value=" + data[j][1] + " disabled></td>
        // <td><input type='text' id='quantity" + j + "' placeholder='الكمية' name ='items'></td>
        var table = `
                        <table id="datatables">
                            <tr>
                                <th>الصنف</th>
                                <th>السعر</th>
                                <th>الكمية</th>

                            </tr>
                            <tbody>`+ datTable + `</tbody>
                        </table>
                `;
        $('.status-item').append(table);
    });

    function UploadFile() {
        var files = document.getElementById('file').files;
        if (files.length > 0) {
            var formData = new FormData();
            formData.append("file", files[0]);
            formData.append("userid", userid);

            var xhttp = new XMLHttpRequest();

            // Set POST method and ajax file path
            xhttp.open("POST", "../../phpFiles/uploadfile.php", true);
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var response = this.responseText;
                    if (response == 1) {
                        alert("تم رفع الملف بنجاح");
                    } else {
                        alert("حدثت مشكلة في رفع الملف");
                    }
                }
            };
            // Send request with data
            xhttp.send(formData);
        } else {
            alert("رجاءً اختر ملف اولاً");
        }
    }


    function Calc() {
        var total_price = 0;
        var the_row;
        for (let i = 0; i < items.length; i++) {
            the_row = document.getElementById('quantity' + i).value ? document.getElementById('quantity' + i).value : 0;
            total_price += (items[i][1] * the_row);
        }
        document.getElementById('totalPrice').value = total_price;
    }

    function AddOrder() {
        var item_data = "";
        var Order_data = [];
        if (document.getElementById('totalPrice').value) {
            for (let i = 0; i < items.length; i++) {
                item_data += document.getElementById('quantity' + i).value ? (String(document.getElementById('quantity' + i).value) + ",") : "0,";
            }
            Order_data.push(document.getElementById('name').value);
            Order_data.push(document.getElementById('note').value);

            console.log(Order_data);

            var files = document.getElementById('file').files;
            if (files.length > 0) {
                var formData = new FormData();
                formData.append("file", files[0]);
                formData.append("userid", userid);
                formData.append("name", Order_data[0]);
                formData.append("note", Order_data[1]);
                formData.append("items", item_data);

                var xhttp = new XMLHttpRequest();

                // Set POST method and ajax file path
                xhttp.open("POST", "../../phpFiles/orders/addorder.php", true);
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        var response = this.responseText;
                        if (response == 1) {
                            alert("تم رفع الملف بنجاح");
                            window.location.replace("orders.html");

                        } else {
                            alert("حدثت مشكلة في رفع الملف");
                        }
                    }
                };
                // Send request with data
                xhttp.send(formData);
            } else {
                alert("رجاءً اختر ملف اولاً");
            }
            // Order_data.push(document.getElementById('name').value);
            // Order_data.push(document.getElementById('note').value);
            // Order_data.push(item_data);
            // console.log(Order_data);
            // $.post("../../phpFiles/orders/addorder.php?name=" + Order_data[0] + "&userid=" + userid + "&note=" + Order_data[1] + "&items=" + item_data, {
            //     webToken: document.cookie
            // },
            //     function (response) {
            //         var jsonData = JSON.parse(response);
            //         if (jsonData.success == "1") {
            //             alert(" تم حفظ ");
            //             window.location.replace("http://127.0.0.1:8885/CartonProduct/html/orders/orders.html");
            //         }
            //     });
        }
        else {
            alert("رجاءً ادخل كميات اولاً");
        }

    }
</script>

</html>